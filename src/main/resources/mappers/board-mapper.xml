<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "mybatis-3-mapper.dtd" >
<mapper namespace="boardMapper">

  <!-- Board DTO 매핑 -->
  <resultMap id="boardResultMap" type="BoardDto">
    <result column="board_no" property="boardNo" />
    <result column="board_type_no" property="boardTypeNo" />
    <result column="board_dept" property="boardDept" /> 
    <result column="board_title" property="boardTitle" />
    <result column="board_content" property="boardContent" />
    <result column="board_count" property="boardCount" />
    <result column="emp_no" property="empNo" />	
    <result column="create_date" property="createDate" />	
    <result column="modifier" property="modifier" />	
    <result column="modify_date" property="modifyDate" />	
    <result column="user_yn" property="userYN" />	
    <result column="emp_name" property="empName" />	
    <result column="dept_name" property="deptName" />	
    <result column="boardt_name" property="boardtName"/>
    
    <collection resultMap="boardFileResultMap" property="boardList" />
  </resultMap>

  <!-- BoardFile DTO 매핑 -->
  <resultMap id="boardFileResultMap" type="BoardFileDto">
    <result column="BOARDFILE_NO" property="boardFileNo"/>
    <result column="FILE_PATH" property="filePath"/>
    <result column="FILESYSTEM_NAME" property="fileSystemName"/>
    <result column="ORIGINAL_NAME" property="originalName"/>
    <result column="UPLOAD_DATE" property="uploadDate"/>
    <result column="REF_TYPE" property="refType"/>
    <result column="REF_NO" property="refNo"/>
    <result column="CREATER" property="creater"/>
    <result column="CREATE_DATE" property="createDate"/>
    <result column="MODIFIER" property="modifier"/>
    <result column="MODIFY_DATE" property="modifyDate"/>
    <result column="USE_YN" property="useYN"/>
  </resultMap>	

  <!-- 게시글 목록 갯수 -->
  <select id="selectBoardListCount" resultType="_int">
    SELECT COUNT(*) 
    FROM tbl_board b 
    WHERE b.USE_YN = 'Y'
  </select>

  <!-- 게시글 목록 조회 -->
  <select id="selectBoardList" resultMap="boardResultMap">
    SELECT 
      b.board_no, 
      b.board_dept, 
      b.board_title, 
       (SELECT emp_name
         FROM tbl_employee e
         WHERE e.emp_no = b.emp_no) AS emp_name,
      TO_CHAR(b.create_date, 'YYYY-MM-DD') AS "create_date", 
      b.board_Count, 
      ( 
        SELECT COUNT(*) 
        FROM tbl_boardFile s
        WHERE s.ref_type = 'B' 
        AND s.ref_no = b.board_no
      ) AS "attach_count" 
    FROM tbl_board b 
    WHERE b.USE_YN = 'Y' 
    ORDER BY b.board_no DESC
  </select>

  <!-- 검색된 게시글 갯수 -->
  <select id="selectSearchListCount" resultType="_int">
    SELECT COUNT(*) 
    FROM tbl_board b 
    LEFT JOIN tbl_employee e ON e.emp_no = b.modifier 
    WHERE b.USE_YN = 'Y' 
      AND ${condition} LIKE '%' || #{keyword} || '%'
  </select>

  <!-- 검색된 게시글 목록 조회 -->
  <select id="selectSearchList" resultMap="boardResultMap">
    SELECT 
      b.board_no, 
      b.board_dept, 
      b.board_title, 
     (SELECT emp_name
         FROM tbl_employee e
         WHERE e.emp_no = b.emp_no) AS emp_name,
      TO_CHAR(b.create_date, 'YYYY-MM-DD') AS "create_date", 
      b.board_Count, 
      ( 
        SELECT COUNT(*) 
        FROM tbl_boardFile s 
        WHERE s.ref_type = 'B' 
        AND s.ref_no = b.board_no
      ) AS "attach_count" 
    FROM tbl_board b 
    WHERE b.USE_YN = 'Y' 
     and ${condition} like '%' || #{keyword} || '%'
    ORDER BY b.board_no DESC
  </select>
  
  <insert id="insertBoard">
		insert
			into tbl_board
			(
				board_no
			,	board_type_no
			, board_dept
			,	board_title
			,	board_content
			,	emp_no
			, create_Date
			, use_YN  
			
			)
			
			values
			(
				seq_bno.nextval
			, #{ board_type_no }
			, #{ boardDept }
			, #{ boardTitle }
			, #{ boardContent }
			, #{ emp_no }
			, SYSDATE
			, 'Y'
	
			)
			
			
	</insert>
	
	<select id="deptName" resultMap="boardResultMap">

		SELECT dept_name
			FROM tbl_department
			WHERE dept_name LIKE '%부' OR dept_name LIKE '지점'
	
	</select>
	
	<select id="boardtName" resultMap="boardResultMap">
		select boardt_name
        from tbl_boardtype
         where USE_YN = 'Y'
	</select>
	
	
	
	<insert id ="insertAttach">
		insert
			into tbl_boardfile
			(
				BOARDFILE_NO
			,	FILE_PATH
			,	FILESYSTEM_NAME
			,	ORIGINAL_NAME
			,	UPLOAD_DATE
			,	REF_TYPE
			,	REF_NO
			,	CREATER
			,	CREATE_DATE
			,	MODIFIER
			,	MODIFY_DATE
			,	USE_YN
			
			)
			values
			(
				boardfile_no_seq.nextval
			, #{filePath}
			, #{filesystemName}
			, #{originalName}
			, SYSDATE			
			, #{refType}
			
			<choose>
				<when test="refNo == 0">
						, board_no_seq.currval	
				</when>
				<otherwise>
						, #{refNo}			
				</otherwise>
			</choose>
			
			, #{creater}
			, #{createDate}
			, NULL
			, NULL
			, #{useYN}
			
			)
	</insert>
	
	
  
  
  
  
  
  

</mapper>
